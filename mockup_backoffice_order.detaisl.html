<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mockup Pedido v2 - Totales Dinámicos</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body {
      background-color: #f8fafc;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    /* Animaciones del Acordeón */
    .accordion-content {
      transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
    }
    
    .accordion-content.open {
      max-height: 2000px; /* Aumentado para soportar anidamientos */
      opacity: 1;
    }

    .rotate-icon {
      transition: transform 0.3s ease;
    }
    
    .rotate-icon.rotated {
      transform: rotate(180deg);
    }

    /* Grid Custom para alineación perfecta */
    .grid-row {
      display: grid;
      grid-template-columns: 3fr 0.8fr 1fr 1fr; /* Ajusté un poco los anchos */
      align-items: center;
    }
  </style>
</head>
<body class="p-4 md:p-10">

  <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden border border-gray-200">
    
    <!-- Header -->
    <div class="bg-slate-900 text-white text-xs uppercase font-bold py-4 px-6 grid-row tracking-wider">
      <div>Detalle del Pedido</div>
      <div class="text-center">Cant.</div>
      <div class="text-right">Precio Base</div>
      <div class="text-right">Total</div>
    </div>

    <!-- Contenedor Dinámico -->
    <div id="order-container" class="divide-y divide-gray-100"></div>

    <!-- Footer Totales -->
    <div class="bg-slate-50 p-6 border-t border-gray-200">
      <div class="flex justify-end items-center mb-2">
        <span class="text-gray-500 mr-4 text-sm">Subtotal</span>
        <span class="text-gray-900 font-bold" id="sub-total">$0</span>
      </div>
      <div class="flex justify-end items-center mb-4">
        <span class="text-gray-500 mr-4 text-sm">Envío</span>
        <span class="text-green-600 font-bold text-sm">Gratis</span>
      </div>
      <div class="border-t border-gray-300 my-2"></div>
      <div class="flex justify-end items-center mt-4">
        <span class="text-slate-800 mr-6 text-xl font-bold">Total a Pagar</span>
        <span class="text-3xl text-slate-900 font-extrabold" id="grand-total">$0</span>
      </div>
    </div>

  </div>

  <script>
    // --- DATOS JSON ---
    const orderData = {
      "details": [
        {
          "itemType": "COMBO",
          "itemId": "10001",
          "sku": "10001",
          "itemDescription": "Combo 1 - Crispy",
          "price": 19900,
          "discount": 0,
          "quantity": 1,
          "customizations": null,
          "includedItems": [
            {
              "itemType": "PRODUCT",
              "itemId": "27",
              "sku": "27",
              "itemDescription": "Burguer Crispy",
              "price": 0,
              "discount": 0,
              "quantity": 1,
              "customizations": {
                "observation": "",
                "removedComponents": [
                  { "itemType": "COMPONENT", "itemId": "26", "sku": "26", "itemDescription": "Sin tomate", "price": 0, "quantity": 1 }
                ],
                "extras": [
                  { "itemType": "COMPONENT", "itemId": "1", "sku": "1", "itemDescription": "Extra Medallon de Carne", "price": 3000, "quantity": 1 }
                ]
              }
            },
            { "itemType": "PRODUCT", "itemId": "12", "sku": "12", "itemDescription": "Papas fritas", "price": 0, "quantity": 1, "customizations": null },
            { "itemType": "PRODUCT", "itemId": "4", "sku": "4", "itemDescription": "Pepsi", "price": 0, "quantity": 1, "customizations": null }
          ]
        },
        {
          "itemType": "COMBO",
          "itemId": "10001",
          "sku": "10001",
          "itemDescription": "Combo 1 - Gulosa",
          "price": 19900,
          "discount": 0,
          "quantity": 1,
          "customizations": {
            "observation": "Sin sal porfavor"
          },
          "includedItems": [
            { "itemType": "PRODUCT", "itemId": "9", "sku": "9", "itemDescription": "Gulosa", "price": 0, "quantity": 1, "customizations": null },
            { "itemType": "PRODUCT", "itemId": "104", "sku": "104", "itemDescription": "H2O Pomelo", "price": 0, "quantity": 1, "customizations": null },
            { "itemType": "PRODUCT", "itemId": "12", "sku": "12", "itemDescription": "Papas fritas", "price": 0, "quantity": 1, "customizations": null },
            { "itemType": "PRODUCT", "itemId": "164", "sku": "164", "itemDescription": "Helado Paleta Frutilla", "price": 4000, "quantity": 1, "customizations": null }
          ]
        },
        {
          "itemType": "PRODUCT",
          "itemId": "9",
          "sku": "9",
          "itemDescription": "Gulosa",
          "price": 12000,
          "discount": 0,
          "quantity": 1,
          "customizations": {
            "observation": "Sin sal porfavor",
            "removedComponents": [],
            "extras": []
          },
          "includedItems": null
        },
        { "itemType": "PRODUCT", "itemId": "12", "sku": "12", "itemDescription": "Papas fritas", "price": 4000, "quantity": 1, "customizations": null },
        { "itemType": "PRODUCT", "itemId": "4", "sku": "4", "itemDescription": "Pepsi", "price": 4000, "quantity": 2, "customizations": null }
      ]
    };

    // --- UTILIDADES ---
    const formatMoney = (amount) => {
      return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(amount);
    };

    // --- LÓGICA DE CÁLCULO DE PRECIOS COMPUESTOS ---
    
    // Esta función calcula el costo unitario REAL de un item (sumando extras internos y upgrades)
    function calculateEffectiveUnitPrice(item) {
      let total = item.price; // Precio base (ej: 19900)

      // 1. Sumar upgrades de items incluidos (ej: Helado +4000)
      if (item.includedItems) {
        item.includedItems.forEach(child => {
           // Sumamos el precio del hijo (si es un upgrade)
           total += child.price;
           
           // Sumamos recursivamente los extras que tenga ese hijo (ej: Extra Medallón dentro de la Burger del Combo)
           if (child.customizations?.extras) {
             child.customizations.extras.forEach(extra => {
               total += extra.price;
             });
           }
        });
      }

      // 2. Sumar extras propios del item (si no fuera un combo, o si el combo tuviera extras directos)
      if (item.customizations?.extras) {
        item.customizations.extras.forEach(extra => {
          total += extra.price;
        });
      }

      return total;
    }


    // --- RENDERIZADO ---

    function renderOrderList(details) {
      const container = document.getElementById('order-container');
      let grandTotal = 0;

      details.forEach(item => {
        // Calculamos el precio real compuesto (Base + Extras + Upgrades)
        const effectiveUnitPrice = calculateEffectiveUnitPrice(item);
        const rowTotal = effectiveUnitPrice * item.quantity;
        
        grandTotal += rowTotal;

        // Renderizamos pasando el precio calculado
        const itemRow = createItemRow(item, 'root', 1, effectiveUnitPrice);
        container.appendChild(itemRow);
      });

      document.getElementById('sub-total').textContent = formatMoney(grandTotal);
      document.getElementById('grand-total').textContent = formatMoney(grandTotal);
    }

    function createItemRow(item, type = 'root', parentQty = 1, effectiveTotalOverride = null) {
      // Detección de hijos para el dropdown
      const hasIncluded = item.includedItems && item.includedItems.length > 0;
      const hasRemoved = item.customizations?.removedComponents?.length > 0;
      const hasExtras = item.customizations?.extras?.length > 0;
      const hasObservation = item.customizations?.observation && item.customizations.observation.length > 0;
      const hasChildren = hasIncluded || hasRemoved || hasExtras || hasObservation;

      // Configuración de Estilos
      let bgColor = type === 'root' ? 'bg-white hover:bg-gray-50' : 'bg-slate-50 border-t border-gray-100';
      let paddingLeft = type === 'root' ? 'px-6' : 'pl-12 pr-6';
      let titleClass = type === 'root' ? 'font-bold text-gray-800 text-base' : 'font-medium text-gray-700 text-sm';
      let badgeHTML = '';

      // Badges
      if (type === 'included') {
        if (item.price > 0) {
           badgeHTML = `<span class="bg-yellow-100 text-yellow-800 text-[10px] font-bold px-2 py-0.5 rounded uppercase mr-2 border border-yellow-200">Extra</span>`;
        } else {
           badgeHTML = `<span class="bg-blue-100 text-blue-800 text-[10px] font-bold px-2 py-0.5 rounded uppercase mr-2 border border-blue-200">Incluye</span>`;
        }
      }

      // Cálculos visuales para las columnas
      // Si recibimos un override (calculado desde el padre para el total completo), lo usamos en la col Total.
      // Si no (items hijos), calculamos normal.
      const currentUnitObjPrice = item.price;
      const currentTotalRowPrice = effectiveTotalOverride !== null 
                                   ? effectiveTotalOverride * item.quantity 
                                   : item.price * parentQty;

      // HTML Header
      const containerDiv = document.createElement('div');
      containerDiv.className = 'group';

      const headerDiv = document.createElement('div');
      headerDiv.className = `${bgColor} grid-row py-4 ${paddingLeft} transition-colors cursor-pointer relative`;
      
      const chevronIcon = hasChildren 
        ? `<i class="fa-solid fa-chevron-down text-gray-400 mr-3 text-xs rotate-icon group-hover:text-blue-500"></i>` 
        : `<span class="mr-6"></span>`;

      // Definir qué mostrar en las columnas de precio
      // Precio Base: Muestra el precio de lista del item (ej: 19900).
      // Total: Muestra el acumulado real (ej: 22900).
      let displayBasePrice = formatMoney(item.price);
      let displayTotalPrice = formatMoney(currentTotalRowPrice);
      let displayQty = type === 'root' ? item.quantity : (item.price > 0 ? parentQty : '<span class="text-gray-300">-</span>');

      // Limpieza visual para items $0
      if(item.price === 0 && type !== 'root') {
          displayBasePrice = '<span class="text-gray-300">$0</span>';
          if(currentTotalRowPrice === 0) displayTotalPrice = '<span class="text-gray-300">$0</span>';
      }

      headerDiv.innerHTML = `
        <div class="flex items-center">
          ${chevronIcon}
          <div class="flex flex-col">
            <div class="flex items-center">
              ${badgeHTML}
              <span class="${titleClass}">${item.itemDescription}</span>
            </div>
            ${item.sku ? `<span class="text-[10px] text-gray-400 mt-0.5">SKU: ${item.sku}</span>` : ''}
          </div>
        </div>
        <div class="text-center text-sm font-medium text-gray-600">${displayQty}</div>
        <div class="text-right text-sm font-medium text-gray-500">${displayBasePrice}</div>
        <div class="text-right text-sm font-bold text-gray-800">${displayTotalPrice}</div>
      `;

      containerDiv.appendChild(headerDiv);

      // Contenido Desplegable
      if (hasChildren) {
        const contentDiv = document.createElement('div');
        contentDiv.className = 'accordion-content bg-gray-50 shadow-inner';
        
        // 1. Observaciones (Cambio de nombre "Nota" -> "Observación")
        if (hasObservation) {
            const obsRow = document.createElement('div');
            // Detectar nivel para indentación visual
            const indent = type === 'root' ? 'pl-14' : 'pl-20';
            obsRow.className = `grid-row py-2 ${indent} pr-6 border-l-4 border-amber-200 bg-amber-50/50`;
            obsRow.innerHTML = `
                <div class="flex items-center col-span-4 text-xs text-amber-800 italic font-medium">
                    <i class="fa-regular fa-comment-dots mr-2"></i> Observación: "${item.customizations.observation}"
                </div>
            `;
            contentDiv.appendChild(obsRow);
        }

        // 2. Items Incluidos (Recursivo)
        if (hasIncluded) {
          item.includedItems.forEach(subItem => {
            contentDiv.appendChild(createItemRow(subItem, 'included', item.quantity));
          });
        }

        // 3. Customizations (Extras y Removed)
        // Indentación dinámica según si estamos en root o dentro de un combo
        const detailIndent = type === 'root' ? 'pl-14' : 'pl-20';

        if (hasRemoved) {
          item.customizations.removedComponents.forEach(rem => {
            contentDiv.appendChild(createDetailRow(rem, 'removed', detailIndent));
          });
        }
        if (hasExtras) {
          item.customizations.extras.forEach(ext => {
             contentDiv.appendChild(createDetailRow(ext, 'extra', detailIndent, item.quantity));
          });
        }

        containerDiv.appendChild(contentDiv);

        // Click Event
        headerDiv.addEventListener('click', () => {
          contentDiv.classList.toggle('open');
          const icon = headerDiv.querySelector('.rotate-icon');
          if(icon) icon.classList.toggle('rotated');
        });
      }

      return containerDiv;
    }

    function createDetailRow(detail, type, paddingClass, parentQty = 1) {
      const row = document.createElement('div');
      row.className = `grid-row py-2 ${paddingClass} pr-6 border-l border-dotted border-gray-300`;
      
      let badge = '';
      let price = '$0';
      let total = '$0';
      let textClass = 'text-gray-600';

      if (type === 'removed') {
        // CORRECCIÓN: Eliminado 'line-through' y decoration
        badge = `<span class="bg-red-100 text-red-600 text-[10px] font-bold px-2 py-0.5 rounded uppercase mr-2 border border-red-200">Opcional</span>`;
        textClass = 'text-gray-500 italic'; 
      } else if (type === 'extra') {
        badge = `<span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-0.5 rounded uppercase mr-2 border border-emerald-200">Extra</span>`;
        price = formatMoney(detail.price);
        total = formatMoney(detail.price * parentQty);
        textClass = 'text-gray-700 font-medium';
      }

      row.innerHTML = `
        <div class="flex items-center">
          ${badge}
          <span class="text-xs ${textClass}">${type === 'removed' ? 'Sin ' : ''}${detail.itemDescription}</span>
        </div>
        <div class="text-center text-xs text-gray-400">-</div>
        <div class="text-right text-xs text-gray-500">${price}</div>
        <div class="text-right text-xs text-gray-500">${total}</div>
      `;
      return row;
    }

    // Inicializar
    renderOrderList(orderData.details);

  </script>
</body>
</html>
